#!/bin/bash
# fcitx5-tmux-hook: called by tmux on pane focus/switch events
#
# Shell-agnostic. No shell configuration needed.
# Constructs a deterministic context ID from tmux's own metadata:
#   tmux-<hostname>-<session_name>-<pane_unique_id>
#
# Sends OSC 1337 SetUserVar directly to the client tty (raw, no DCS wrapper).
# Works identically on local and remote machines.
#
# Usage:
#   fcitx5-tmux-hook focus-in <pane_id>    (pane-focus-in hook)
#   fcitx5-tmux-hook focus-out <pane_id>   (pane-focus-out hook)
#   fcitx5-tmux-hook <pane_id>             (after-select-pane: handles both)

_get_ctx_id() {
    local pane_id="$1"
    local host session unique_pane_id
    host=$(hostname -s 2>/dev/null || echo "unknown")
    session=$(tmux display-message -p -t "$pane_id" '#S' 2>/dev/null || echo "_")
    # Use pane_id (%1, %2) which is stable across moves/renumbers
    # instead of #I-#P which changes.
    # This fixes "random pane" issues if panes are reordered.
    unique_pane_id=$(tmux display-message -p -t "$pane_id" '#D' 2>/dev/null || echo "_")
    # Remove the % prefix for cleaner IDs
    unique_pane_id=${unique_pane_id%%%}
    unique_pane_id=${unique_pane_id#%}

    echo "tmux-${host}-${session}-${unique_pane_id}"
}

_send_user_var() {
    local key="fcitx5_ctx"
    local value
    value=$(printf '%s' "$1" | base64)

    local client_tty
    client_tty=$(tmux display-message -p '#{client_tty}' 2>/dev/null)

    if [[ -n "$client_tty" ]]; then
        # Check if writable, otherwise try to use tmux display-message to passthrough if needed
        # But usually client_tty is writable by the user who owns the tmux server process
        # Using base64 to ensure no weird character issues in the protocol
        printf '\e]1337;SetUserVar=%s=%s\a' "$key" "$value" > "$client_tty" 2>/dev/null
    fi
}

# Explicit mode: fcitx5-tmux-hook focus-in/focus-out <pane_id>
# For pane-focus-in / pane-focus-out hooks.
if [[ "$1" == "focus-in" || "$1" == "focus-out" ]]; then
    ctx_id=$(_get_ctx_id "$2")
    _send_user_var "$1:$ctx_id"
    exit 0
fi

# Fallback for unified mode (if called without action) - just treat as focus-in
# But since we enabled explicit focus-out hook in tmux.conf, we can simplify this.
# Or keep it for backward compat / manual calls.
if [[ $# -eq 1 ]]; then
    pane_id="$1"
    ctx_id=$(_get_ctx_id "$pane_id")
    _send_user_var "focus-in:$ctx_id"
    exit 0
fi
