#!/bin/bash
# fcitx5-tmux-hook: called by tmux on pane focus/switch events
#
# Shell-agnostic. No shell configuration needed.
# Constructs a deterministic context ID from tmux's own metadata:
#   tmux-<hostname>-<session_name>-<window_index>-<pane_index>
#
# Sends OSC 1337 SetUserVar via DCS passthrough to the outer terminal (kitty).
# Works identically on local and remote machines.
#
# Usage:
#   fcitx5-tmux-hook focus-in <pane_id>    (pane-focus-in hook)
#   fcitx5-tmux-hook focus-out <pane_id>   (pane-focus-out hook)
#   fcitx5-tmux-hook <pane_id>             (after-select-pane: handles both)

_get_ctx_id() {
    local pane_id="$1"
    local host session win_idx pane_idx
    host=$(hostname -s 2>/dev/null || echo "unknown")
    session=$(tmux display-message -p -t "$pane_id" '#S' 2>/dev/null || echo "_")
    win_idx=$(tmux display-message -p -t "$pane_id" '#I' 2>/dev/null || echo "_")
    pane_idx=$(tmux display-message -p -t "$pane_id" '#P' 2>/dev/null || echo "_")
    echo "tmux-${host}-${session}-${win_idx}-${pane_idx}"
}

_send_user_var() {
    local key="fcitx5_ctx"
    local value
    value=$(printf '%s' "$1" | base64)

    local client_tty
    client_tty=$(tmux display-message -p '#{client_tty}' 2>/dev/null)

    if [[ -n "$client_tty" && -w "$client_tty" ]]; then
        # Write raw OSC directly to client tty (bypasses tmux, no DCS wrapper needed)
        printf '\e]1337;SetUserVar=%s=%s\a' "$key" "$value" > "$client_tty"
    fi
}

# Unified mode: fcitx5-tmux-hook <pane_id>
# For after-select-pane / after-select-window hooks.
# Tracks previous pane via @fcitx5_last_ctx, sends both focus-out and focus-in.
if [[ $# -eq 1 && "$1" != "focus-in" && "$1" != "focus-out" ]]; then
    pane_id="$1"
    ctx_id=$(_get_ctx_id "$pane_id")
    last_ctx=$(tmux show-option -gqv @fcitx5_last_ctx 2>/dev/null)

    if [[ "$last_ctx" == "$ctx_id" ]]; then
        exit 0
    fi

    if [[ -n "$last_ctx" ]]; then
        _send_user_var "focus-out:$last_ctx"
    fi
    _send_user_var "focus-in:$ctx_id"
    tmux set-option -gq @fcitx5_last_ctx "$ctx_id"
    exit 0
fi

# Explicit mode: fcitx5-tmux-hook focus-in/focus-out <pane_id>
# For pane-focus-in / pane-focus-out hooks.
ctx_id=$(_get_ctx_id "$2")
_send_user_var "$1:$ctx_id"
