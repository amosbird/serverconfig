#!/usr/bin/env bash
set -euo pipefail

# Architecture:
#   clickstock runs ONLY stdiscosrv (private discovery) + a peer registry file.
#   clickstock does NOT run syncthing and does NOT sync data.
#   Clients form a direct mesh: every client connects to every other client.
#   New node: runs this script → registers in peer registry on clickstock →
#   gets peer list → adds all peers locally → SSHes to each peer to add self.
#   Discovery server handles ongoing address resolution.

SEED_TS_IP="100.66.107.106"
SEED_SSH="root@$SEED_TS_IP"
PEER_REGISTRY="/var/lib/syncthing-discosrv/peers.txt"

# Private discovery server (stdiscosrv on clickstock, no syncthing)
DISCO_ID="ZBO5OO5-QD56IFD-EWHDC3A-QH6NXRX-3IXPNWC-3UAXFNL-AEDVQGA-U4EOGQX"
DISCO_URL="https://$DISCO_ID@$SEED_TS_IP:8443/v2/"

SHARED_FOLDERS=(
    "copilot-config|Copilot Config|~/.copilot"
)

# --- Helpers ---
has_device() { syncthing cli config devices list 2>/dev/null | grep -qF "$1"; }
has_folder() { syncthing cli config folders list 2>/dev/null | grep -qF "$1"; }

set_listen_addresses() {
    local indices
    indices=$(syncthing cli config options raw-listen-addresses list 2>/dev/null)
    for i in $(echo "$indices" | sort -rn); do
        syncthing cli config options raw-listen-addresses "$i" delete
    done
    for addr in "$@"; do
        syncthing cli config options raw-listen-addresses add "$addr"
    done
}

set_device_addresses() {
    local dev_id="$1"; shift
    local indices
    indices=$(syncthing cli config devices "$dev_id" addresses list 2>/dev/null)
    for i in $(echo "$indices" | sort -rn); do
        syncthing cli config devices "$dev_id" addresses "$i" delete
    done
    for addr in "$@"; do
        syncthing cli config devices "$dev_id" addresses add "$addr"
    done
}

set_global_discovery() {
    local indices
    indices=$(syncthing cli config options raw-global-ann-servers list 2>/dev/null)
    for i in $(echo "$indices" | sort -rn); do
        syncthing cli config options raw-global-ann-servers "$i" delete
    done
    for url in "$@"; do
        syncthing cli config options raw-global-ann-servers add "$url"
    done
}

get_tailscale_ip() {
    ip addr show tailscale0 2>/dev/null | awk '/inet / {split($2,a,"/"); print a[1]}'
}

LOCAL_ID=$(syncthing cli show system | grep myID | sed 's/.*": "//;s/".*//')
TS_IP=$(get_tailscale_ip)
HOSTNAME=$(hostname | tr -cd 'a-zA-Z0-9._-')
echo "==> Local: $HOSTNAME ($LOCAL_ID)"
echo "==> Tailscale IP: ${TS_IP:-not found}"

[ -z "$TS_IP" ] && { echo "ERROR: tailscale not running"; exit 1; }
[[ "$LOCAL_ID" =~ ^[A-Z0-9-]+$ ]] || { echo "ERROR: invalid device ID"; exit 1; }
[[ "$TS_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]] || { echo "ERROR: invalid tailscale IP"; exit 1; }

# --- Network: tailscale only, private discovery ---
echo "==> Configuring network: tailscale + private discovery"
set_listen_addresses "tcp://$TS_IP:22000" "quic://$TS_IP:22000"
syncthing cli config options global-ann-enabled set true
set_global_discovery "$DISCO_URL"
syncthing cli config options relays-enabled set false
syncthing cli config options local-ann-enabled set false
syncthing cli config options natenabled set false
syncthing cli config options always-local-nets add "100.64.0.0/10" 2>/dev/null || true

# --- Remove clickstock from devices if present (it no longer syncs) ---
CLICKSTOCK_ID="6TKCCHI-IMYMGDN-B3CX2SK-T3674QH-V3B4U4G-IUS4QZI-6QO427R-G6T7PQS"
if has_device "$CLICKSTOCK_ID"; then
    echo "==> Removing clickstock (no longer a sync peer)"
    syncthing cli config devices "$CLICKSTOCK_ID" delete 2>/dev/null || true
fi

# --- Register in peer registry and get peer list ---
echo "==> Registering in peer registry on seed..."
PEER_DATA=$(ssh "$SEED_SSH" bash -s <<REMOTE
    REGISTRY='$PEER_REGISTRY'
    touch "\$REGISTRY"

    # Update or add this device
    if grep -qF '$LOCAL_ID' "\$REGISTRY"; then
        sed -i '/^$LOCAL_ID|/d' "\$REGISTRY"
    fi
    echo '$LOCAL_ID|$HOSTNAME|$TS_IP' >> "\$REGISTRY"

    cat "\$REGISTRY"
REMOTE
)

# --- Add all peers (full mesh) ---
echo "==> Building mesh..."
echo "$PEER_DATA" | while IFS='|' read -r peer_id peer_name peer_ip; do
    [ -z "$peer_id" ] && continue
    [ "$peer_id" = "$LOCAL_ID" ] && continue
    [[ "$peer_id" =~ ^[A-Z0-9-]+$ ]] || continue

    if has_device "$peer_id"; then
        echo "  Updating: $peer_name ($peer_ip)"
        set_device_addresses "$peer_id" "dynamic" "tcp://$peer_ip:22000" "quic://$peer_ip:22000"
    else
        echo "  Adding: $peer_name ($peer_ip)"
        syncthing cli config devices add \
            --device-id "$peer_id" --name "$peer_name" \
            --addresses "dynamic" \
            --addresses "tcp://$peer_ip:22000" \
            --addresses "quic://$peer_ip:22000"
    fi

    # Bidirectional: SSH to peer to add ourselves
    echo "    -> Registering on $peer_name..."
    ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new "$peer_ip" "
        syncthing cli config devices list 2>/dev/null | grep -qF '$LOCAL_ID' || \
            syncthing cli config devices add --device-id '$LOCAL_ID' --name '$HOSTNAME' \
                --addresses 'dynamic' --addresses 'tcp://$TS_IP:22000' --addresses 'quic://$TS_IP:22000' 2>/dev/null
        for fid in copilot-config; do
            syncthing cli config folders \"\$fid\" devices add --device-id '$LOCAL_ID' 2>/dev/null || true
        done
    " 2>/dev/null || echo "    Warning: could not reach $peer_ip"
done

# --- Shared folders ---
echo "==> Configuring folders..."
for entry in "${SHARED_FOLDERS[@]}"; do
    IFS='|' read -r fid flabel fpath <<< "$entry"
    fpath="${fpath/#\~/$HOME}"
    mkdir -p "$fpath"

    if has_folder "$fid"; then
        echo "  Folder '$fid' exists"
    else
        echo "  Adding: $flabel ($fpath)"
        syncthing cli config folders add --id "$fid" --label "$flabel" --path "$fpath"
    fi

    # Share with all peers
    echo "$PEER_DATA" | while IFS='|' read -r peer_id _ _; do
        [ -z "$peer_id" ] || [ "$peer_id" = "$LOCAL_ID" ] && continue
        [[ "$peer_id" =~ ^[A-Z0-9-]+$ ]] || continue
        syncthing cli config folders "$fid" devices add --device-id "$peer_id" 2>/dev/null || true
    done
done

# --- .stignore ---
COPILOT_DIR="$HOME/.copilot"
if [ ! -f "$COPILOT_DIR/.stignore-shared" ]; then
    cat > "$COPILOT_DIR/.stignore-shared" << 'IGN'
// Syncthing selective sync for ~/.copilot
/pkg
/logs
.stfolder
*.tmp
*.lock
*.db-journal
*.db-wal
*.db-shm
IGN
    echo "==> Created .stignore-shared"
fi
if [ ! -f "$COPILOT_DIR/.stignore" ]; then
    echo '#include .stignore-shared' > "$COPILOT_DIR/.stignore"
    echo "==> Created .stignore"
fi

TOTAL_PEERS=$(echo "$PEER_DATA" | grep -v "$LOCAL_ID" | grep -c '^[A-Z]' || true)
echo ""
echo "==> Done! $HOSTNAME in mesh with $TOTAL_PEERS peer(s)"
echo "    Discovery: private stdiscosrv @ $SEED_TS_IP"
