#!/usr/bin/env bash
set -euo pipefail

INTRODUCER_ID="6TKCCHI-IMYMGDN-B3CX2SK-T3674QH-V3B4U4G-IUS4QZI-6QO427R-G6T7PQS"
INTRODUCER_NAME="clickstock"
INTRODUCER_SSH="root@100.66.107.106"

# Shared folders: id|label|path
SHARED_FOLDERS=(
    "copilot-config|Copilot Config|~/.copilot"
)

# --- Helper ---
has_device() { syncthing cli config devices list 2>/dev/null | grep -qF "$1"; }
has_folder() { syncthing cli config folders list 2>/dev/null | grep -qF "$1"; }

get_tailscale_ip() {
    ip addr show tailscale0 2>/dev/null | awk '/inet / {split($2,a,"/"); print a[1]}'
}

LOCAL_ID=$(syncthing cli show system | grep myID | sed 's/.*": "//;s/".*//')
TS_IP=$(get_tailscale_ip)
echo "==> Local Device ID: $LOCAL_ID"
echo "==> Tailscale IP: ${TS_IP:-not found}"

if [ -z "$TS_IP" ]; then
    echo "WARNING: tailscale not running or no IP assigned"
fi

# --- Introducer mode (on introducer itself) ---
if [ "$LOCAL_ID" = "$INTRODUCER_ID" ]; then
    echo "==> This IS the introducer, configuring..."

    # Auto-accept folders from new devices
    syncthing cli config defaults device auto-accept-folders set true

    # Only listen on tailscale IP (restrict to tailnet only)
    if [ -n "$TS_IP" ]; then
        echo "==> Binding to tailscale only: tcp://$TS_IP:22000, quic://$TS_IP:22000"
        syncthing cli config options raw-listen-addresses set "tcp://$TS_IP:22000" "quic://$TS_IP:22000"
    fi

    # Disable global discovery & relaying (tailscale handles connectivity)
    syncthing cli config options global-ann-enabled set false
    syncthing cli config options relays-enabled set false

    # Keep local discovery for LAN peers also on tailnet
    syncthing cli config options local-ann-enabled set true

    # GUI only on localhost
    syncthing cli config gui raw-address set "127.0.0.1:8384"
fi

# --- Add introducer (skip on introducer itself) ---
if [ "$LOCAL_ID" = "$INTRODUCER_ID" ]; then
    echo "==> Skipping introducer self-add"
elif has_device "$INTRODUCER_ID"; then
    echo "==> Introducer already added, ensuring introducer=true + auto-accept"
    syncthing cli config devices "$INTRODUCER_ID" introducer set true
    syncthing cli config devices "$INTRODUCER_ID" auto-accept-folders set true
else
    echo "==> Adding introducer: $INTRODUCER_NAME ($INTRODUCER_ID)"
    syncthing cli config devices add \
        --device-id "$INTRODUCER_ID" \
        --name "$INTRODUCER_NAME" \
        --introducer \
        --auto-accept-folders
fi

# --- Register this device on introducer via SSH ---
if [ "$LOCAL_ID" != "$INTRODUCER_ID" ]; then
    echo "==> Registering this device on introducer ($INTRODUCER_NAME) via SSH..."
    HOSTNAME=$(hostname)
    ssh "$INTRODUCER_SSH" "
        if syncthing cli config devices list | grep -qF '$LOCAL_ID'; then
            echo 'Device already known on introducer'
        else
            syncthing cli config devices add \
                --device-id '$LOCAL_ID' \
                --name '$HOSTNAME' \
                --auto-accept-folders
            echo 'Device added on introducer'
        fi
    "
fi

# --- Add shared folders (all nodes) ---
for entry in "${SHARED_FOLDERS[@]}"; do
    IFS='|' read -r fid flabel fpath <<< "$entry"
    fpath="${fpath/#\~/$HOME}"
    mkdir -p "$fpath"

    if has_folder "$fid"; then
        echo "==> Folder '$fid' already exists"
    else
        echo "==> Adding folder: $flabel ($fpath)"
        syncthing cli config folders add \
            --id "$fid" \
            --label "$flabel" \
            --path "$fpath"
    fi

    # Share folder with introducer (skip on introducer itself)
    if [ "$LOCAL_ID" != "$INTRODUCER_ID" ]; then
        syncthing cli config folders "$fid" devices add \
            --device-id "$INTRODUCER_ID" 2>/dev/null || true

        # Also share on introducer side
        ssh "$INTRODUCER_SSH" "
            syncthing cli config folders '$fid' devices add \
                --device-id '$LOCAL_ID' 2>/dev/null || true
        "
    fi
done

# --- Create .stignore if missing ---
COPILOT_STIGNORE="$HOME/.copilot/.stignore"
COPILOT_STIGNORE_SHARED="$HOME/.copilot/.stignore-shared"

if [ ! -f "$COPILOT_STIGNORE_SHARED" ]; then
    cat > "$COPILOT_STIGNORE_SHARED" << 'IGN'
// Syncthing selective sync for ~/.copilot
/pkg
/logs
.stfolder
*.tmp
*.lock
*.db-journal
*.db-wal
*.db-shm
IGN
    echo "==> Created $COPILOT_STIGNORE_SHARED"
fi

if [ ! -f "$COPILOT_STIGNORE" ]; then
    echo '#include .stignore-shared' > "$COPILOT_STIGNORE"
    echo "==> Created $COPILOT_STIGNORE"
fi

echo ""
echo "==> Done!"
if [ "$LOCAL_ID" = "$INTRODUCER_ID" ]; then
    echo "    Introducer configured: listening on tailscale only."
    echo "    NOTE: New devices must be accepted once (via GUI or CLI), then folders auto-share."
else
    echo "    Configured as client. Registered on introducer via SSH."
    echo "    Folders will propagate via introducer mode."
fi
