#!/usr/bin/env bash
set -euo pipefail

INTRODUCER_ID="6TKCCHI-IMYMGDN-B3CX2SK-T3674QH-V3B4U4G-IUS4QZI-6QO427R-G6T7PQS"
INTRODUCER_NAME="clickstock"
INTRODUCER_TS_IP="100.66.107.106"
INTRODUCER_SSH="root@$INTRODUCER_TS_IP"

SHARED_FOLDERS=(
    "copilot-config|Copilot Config|~/.copilot"
)

# --- Helpers ---
has_device() { syncthing cli config devices list 2>/dev/null | grep -qF "$1"; }
has_folder() { syncthing cli config folders list 2>/dev/null | grep -qF "$1"; }

set_listen_addresses() {
    local indices
    indices=$(syncthing cli config options raw-listen-addresses list 2>/dev/null)
    for i in $(echo "$indices" | sort -rn); do
        syncthing cli config options raw-listen-addresses "$i" delete
    done
    for addr in "$@"; do
        syncthing cli config options raw-listen-addresses add "$addr"
    done
}

set_device_addresses() {
    local dev_id="$1"; shift
    local indices
    indices=$(syncthing cli config devices "$dev_id" addresses list 2>/dev/null)
    for i in $(echo "$indices" | sort -rn); do
        syncthing cli config devices "$dev_id" addresses "$i" delete
    done
    for addr in "$@"; do
        syncthing cli config devices "$dev_id" addresses add "$addr"
    done
}

get_tailscale_ip() {
    ip addr show tailscale0 2>/dev/null | awk '/inet / {split($2,a,"/"); print a[1]}'
}

LOCAL_ID=$(syncthing cli show system | grep myID | sed 's/.*": "//;s/".*//')
TS_IP=$(get_tailscale_ip)
echo "==> Local Device ID: $LOCAL_ID"
echo "==> Tailscale IP: ${TS_IP:-not found}"

[ -z "$TS_IP" ] && { echo "ERROR: tailscale not running"; exit 1; }

# --- Network: tailscale only, no relay/global discovery ---
echo "==> Locking down to tailscale"
set_listen_addresses "tcp://$TS_IP:22000" "quic://$TS_IP:22000"
syncthing cli config options global-ann-enabled set false
syncthing cli config options relays-enabled set false
syncthing cli config options local-ann-enabled set false
syncthing cli config options natenabled set false
# Treat tailscale subnet as local network
syncthing cli config options always-local-nets add "100.64.0.0/10" 2>/dev/null || true

# --- Introducer-specific config ---
if [ "$LOCAL_ID" = "$INTRODUCER_ID" ]; then
    echo "==> This IS the introducer"
    syncthing cli config defaults device auto-accept-folders set true
    syncthing cli config gui raw-address set "127.0.0.1:8384"
fi

# --- Client: add introducer + register via SSH ---
if [ "$LOCAL_ID" != "$INTRODUCER_ID" ]; then
    if has_device "$INTRODUCER_ID"; then
        echo "==> Introducer already added, updating address"
        set_device_addresses "$INTRODUCER_ID" \
            "tcp://$INTRODUCER_TS_IP:22000" "quic://$INTRODUCER_TS_IP:22000"
        syncthing cli config devices "$INTRODUCER_ID" introducer set true
        syncthing cli config devices "$INTRODUCER_ID" auto-accept-folders set true
    else
        echo "==> Adding introducer: $INTRODUCER_NAME"
        syncthing cli config devices add \
            --device-id "$INTRODUCER_ID" \
            --name "$INTRODUCER_NAME" \
            --addresses "tcp://$INTRODUCER_TS_IP:22000" \
            --addresses "quic://$INTRODUCER_TS_IP:22000" \
            --introducer \
            --auto-accept-folders
    fi

    # Register self on introducer with tailscale address
    echo "==> Registering on introducer via SSH..."
    HOSTNAME=$(hostname | tr -cd 'a-zA-Z0-9._-')
    ssh "$INTRODUCER_SSH" bash -s <<REMOTE
        set_device_addresses() {
            local dev_id="\$1"; shift
            local indices
            indices=\$(syncthing cli config devices "\$dev_id" addresses list 2>/dev/null)
            for i in \$(echo "\$indices" | sort -rn); do
                syncthing cli config devices "\$dev_id" addresses "\$i" delete
            done
            for addr in "\$@"; do
                syncthing cli config devices "\$dev_id" addresses add "\$addr"
            done
        }

        if syncthing cli config devices list | grep -qF '$LOCAL_ID'; then
            echo 'Device already known, updating address'
            set_device_addresses '$LOCAL_ID' \
                'tcp://$TS_IP:22000' 'quic://$TS_IP:22000'
        else
            syncthing cli config devices add \\
                --device-id '$LOCAL_ID' \\
                --name '$HOSTNAME' \\
                --addresses 'tcp://$TS_IP:22000' \\
                --addresses 'quic://$TS_IP:22000' \\
                --auto-accept-folders
            echo 'Device added on introducer'
        fi
REMOTE

    # Pull all peer addresses from introducer and set locally
    echo "==> Syncing peer addresses from introducer..."
    ssh "$INTRODUCER_SSH" '
        for dev in $(syncthing cli config devices list); do
            addrs=$(syncthing cli config devices "$dev" dump-json | python3 -c "import json,sys; d=json.load(sys.stdin); print(\" \".join(a for a in d[\"addresses\"] if a != \"dynamic\"))")
            [ -z "$addrs" ] && continue
            echo "$dev $addrs"
        done
    ' | while read -r peer_id peer_addrs; do
        [ "$peer_id" = "$LOCAL_ID" ] || [ "$peer_id" = "$INTRODUCER_ID" ] && continue
        echo "  Setting peer $peer_id -> $peer_addrs"
        # Clear existing addresses
        for i in $(syncthing cli config devices "$peer_id" addresses list 2>/dev/null | sort -rn); do
            syncthing cli config devices "$peer_id" addresses "$i" delete 2>/dev/null
        done
        for addr in $peer_addrs; do
            syncthing cli config devices "$peer_id" addresses add "$addr" 2>/dev/null
        done
    done
fi

# --- Shared folders ---
for entry in "${SHARED_FOLDERS[@]}"; do
    IFS='|' read -r fid flabel fpath <<< "$entry"
    fpath="${fpath/#\~/$HOME}"
    mkdir -p "$fpath"

    if has_folder "$fid"; then
        echo "==> Folder '$fid' already exists"
    else
        echo "==> Adding folder: $flabel ($fpath)"
        syncthing cli config folders add \
            --id "$fid" \
            --label "$flabel" \
            --path "$fpath"
    fi

    if [ "$LOCAL_ID" != "$INTRODUCER_ID" ]; then
        syncthing cli config folders "$fid" devices add \
            --device-id "$INTRODUCER_ID" 2>/dev/null || true
        ssh "$INTRODUCER_SSH" "
            syncthing cli config folders '$fid' devices add \
                --device-id '$LOCAL_ID' 2>/dev/null || true
        "
    fi
done

# --- .stignore ---
COPILOT_STIGNORE="$HOME/.copilot/.stignore"
COPILOT_STIGNORE_SHARED="$HOME/.copilot/.stignore-shared"

if [ ! -f "$COPILOT_STIGNORE_SHARED" ]; then
    cat > "$COPILOT_STIGNORE_SHARED" << 'IGN'
// Syncthing selective sync for ~/.copilot
/pkg
/logs
.stfolder
*.tmp
*.lock
*.db-journal
*.db-wal
*.db-shm
IGN
    echo "==> Created $COPILOT_STIGNORE_SHARED"
fi

if [ ! -f "$COPILOT_STIGNORE" ]; then
    echo '#include .stignore-shared' > "$COPILOT_STIGNORE"
    echo "==> Created $COPILOT_STIGNORE"
fi

echo ""
echo "==> Done! ($LOCAL_ID)"
if [ "$LOCAL_ID" = "$INTRODUCER_ID" ]; then
    echo "    Introducer ready. All devices and folders auto-propagate."
else
    echo "    Connected to introducer. Other devices will be discovered automatically."
fi
