#!/usr/bin/env bash
set -euo pipefail

# Syncthing mesh for ~/.copilot over Tailscale
#
# Topology:
#   - clickstock (introducer): propagates device info to all nodes
#   - All nodes connect directly to each other for actual sync
#   - No discovery servers, no relays — tailscale static addresses only
#
# Usage: run on any new node (must have syncthing running + tailscale up)
#   Only SSH access to clickstock (root@100.66.107.106) is required.
#   The introducer automatically propagates the new device to all existing nodes.

INTRODUCER_IP="100.66.107.106"
INTRODUCER_SSH="root@$INTRODUCER_IP"
INTRODUCER_ID="P6RUYUS-2H2TQOU-UOXGLQD-OGZULWJ-OFDQU7K-E3WRIX7-77F2LXA-LT4OVAT"

FOLDER_ID="copilot-config"
FOLDER_LABEL="Copilot Config"
FOLDER_PATH="$HOME/.copilot"

# ── Helpers ──────────────────────────────────────────────────────────

die() { echo "ERROR: $*" >&2; exit 1; }

get_tailscale_ip() {
    ip addr show tailscale0 2>/dev/null | awk '/inet / {split($2,a,"/"); print a[1]}'
}

# Replace all listen/announcement addresses with given args
replace_list() {
    local key="$1"; shift
    for i in $(syncthing cli config options "$key" list 2>/dev/null | sort -rn); do
        syncthing cli config options "$key" "$i" delete
    done
    for v in "$@"; do
        syncthing cli config options "$key" add "$v"
    done
}

# ── Preflight ────────────────────────────────────────────────────────

LOCAL_ID=$(syncthing cli show system | grep myID | sed 's/.*": "//;s/".*//')
TS_IP=$(get_tailscale_ip)
HOSTNAME=$(hostname | tr -cd 'a-zA-Z0-9._-')

[ -z "$TS_IP" ] && die "tailscale not running"
[[ "$LOCAL_ID" =~ ^[A-Z0-9-]+$ ]] || die "cannot get syncthing device ID"

echo "==> $HOSTNAME ($LOCAL_ID) @ $TS_IP"

# ── Network lockdown: tailscale only ─────────────────────────────────

echo "==> Locking down to tailscale..."
replace_list raw-listen-addresses "tcp://$TS_IP:22000" "quic://$TS_IP:22000"
syncthing cli config options global-ann-enabled set false
syncthing cli config options relays-enabled set false
syncthing cli config options local-ann-enabled set false
syncthing cli config options natenabled set false
syncthing cli config options always-local-nets add "100.64.0.0/10" 2>/dev/null || true

# ── Add introducer ───────────────────────────────────────────────────

echo "==> Adding introducer (clickstock)..."
if ! syncthing cli config devices list | grep -qF "$INTRODUCER_ID"; then
    syncthing cli config devices add \
        --device-id "$INTRODUCER_ID" --name "clickstock-introducer" \
        --addresses "tcp://$INTRODUCER_IP:22000" --addresses "quic://$INTRODUCER_IP:22000"
fi
syncthing cli config devices "$INTRODUCER_ID" introducer set true
syncthing cli config devices "$INTRODUCER_ID" auto-accept-folders set true

# ── Create shared folder ─────────────────────────────────────────────

echo "==> Configuring folder: $FOLDER_ID -> $FOLDER_PATH"
mkdir -p "$FOLDER_PATH"

if ! syncthing cli config folders list | grep -qF "$FOLDER_ID"; then
    syncthing cli config folders add --id "$FOLDER_ID" --label "$FOLDER_LABEL" --path "$FOLDER_PATH"
fi

# Share with introducer
syncthing cli config folders "$FOLDER_ID" devices add --device-id "$INTRODUCER_ID" 2>/dev/null || true
syncthing cli config folders "$FOLDER_ID" devices "$INTRODUCER_ID" introducer set true 2>/dev/null || true

# ── Register on introducer via SSH ────────────────────────────────────

echo "==> Registering on introducer via SSH..."
ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=accept-new "$INTRODUCER_SSH" bash <<REMOTE
set -e

# Add this device if not known
if ! syncthing cli config devices list 2>/dev/null | grep -qF '$LOCAL_ID'; then
    syncthing cli config devices add \
        --device-id '$LOCAL_ID' --name '$HOSTNAME' \
        --addresses 'dynamic' \
        --addresses 'tcp://$TS_IP:22000' --addresses 'quic://$TS_IP:22000'
    echo "  Added device $LOCAL_ID"
else
    echo "  Device already known"
fi

# Share folder with this device
syncthing cli config folders '$FOLDER_ID' devices add --device-id '$LOCAL_ID' 2>/dev/null || true
echo "  Shared $FOLDER_ID"
REMOTE

# ── .stignore ─────────────────────────────────────────────────────────

if [ ! -f "$FOLDER_PATH/.stignore-shared" ]; then
    cat > "$FOLDER_PATH/.stignore-shared" << 'IGN'
// Syncthing selective sync for ~/.copilot
/pkg
/logs
.stfolder
*.tmp
*.lock
*.db-journal
*.db-wal
*.db-shm
IGN
    echo "==> Created .stignore-shared"
fi

if [ ! -f "$FOLDER_PATH/.stignore" ]; then
    echo '#include .stignore-shared' > "$FOLDER_PATH/.stignore"
    echo "==> Created .stignore"
fi

# ── Done ──────────────────────────────────────────────────────────────

echo ""
echo "==> Done! $HOSTNAME registered with introducer."
echo "    Existing peers will be propagated automatically."
echo "    Sync will start once the introducer connects."
