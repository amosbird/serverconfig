#!/usr/bin/env bash
set -euo pipefail

# Architecture:
#   Introducer (clickstock) participates in ALL shared folders.
#   New client runs this script → registers on introducer via SSH →
#   introducer shares folders with client → introducer's "introducer" flag
#   automatically propagates all other peers to the new client.
#   No client-to-client SSH needed.

INTRODUCER_ID="6TKCCHI-IMYMGDN-B3CX2SK-T3674QH-V3B4U4G-IUS4QZI-6QO427R-G6T7PQS"
INTRODUCER_NAME="clickstock"
INTRODUCER_TS_IP="100.66.107.106"
INTRODUCER_SSH="root@$INTRODUCER_TS_IP"

SHARED_FOLDERS=(
    "copilot-config|Copilot Config|~/.copilot"
)

# --- Helpers ---
has_device() { syncthing cli config devices list 2>/dev/null | grep -qF "$1"; }
has_folder() { syncthing cli config folders list 2>/dev/null | grep -qF "$1"; }

set_listen_addresses() {
    local indices
    indices=$(syncthing cli config options raw-listen-addresses list 2>/dev/null)
    for i in $(echo "$indices" | sort -rn); do
        syncthing cli config options raw-listen-addresses "$i" delete
    done
    for addr in "$@"; do
        syncthing cli config options raw-listen-addresses add "$addr"
    done
}

set_device_addresses() {
    local dev_id="$1"; shift
    local indices
    indices=$(syncthing cli config devices "$dev_id" addresses list 2>/dev/null)
    for i in $(echo "$indices" | sort -rn); do
        syncthing cli config devices "$dev_id" addresses "$i" delete
    done
    for addr in "$@"; do
        syncthing cli config devices "$dev_id" addresses add "$addr"
    done
}

get_tailscale_ip() {
    ip addr show tailscale0 2>/dev/null | awk '/inet / {split($2,a,"/"); print a[1]}'
}

LOCAL_ID=$(syncthing cli show system | grep myID | sed 's/.*": "//;s/".*//')
TS_IP=$(get_tailscale_ip)
echo "==> Local Device ID: $LOCAL_ID"
echo "==> Tailscale IP: ${TS_IP:-not found}"

[ -z "$TS_IP" ] && { echo "ERROR: tailscale not running"; exit 1; }

# Validate inputs
[[ "$LOCAL_ID" =~ ^[A-Z0-9-]+$ ]] || { echo "ERROR: invalid device ID"; exit 1; }
[[ "$TS_IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]] || { echo "ERROR: invalid tailscale IP"; exit 1; }

# --- Network: tailscale only ---
echo "==> Locking down to tailscale"
set_listen_addresses "tcp://$TS_IP:22000" "quic://$TS_IP:22000"
syncthing cli config options global-ann-enabled set false
syncthing cli config options relays-enabled set false
syncthing cli config options local-ann-enabled set false
syncthing cli config options natenabled set false
syncthing cli config options always-local-nets add "100.64.0.0/10" 2>/dev/null || true

# --- Introducer setup (runs on clickstock itself) ---
if [ "$LOCAL_ID" = "$INTRODUCER_ID" ]; then
    echo "==> This IS the introducer"
    syncthing cli config defaults device auto-accept-folders set true
    syncthing cli config gui raw-address set "127.0.0.1:8384"

    # Ensure introducer has all shared folders
    for entry in "${SHARED_FOLDERS[@]}"; do
        IFS='|' read -r fid flabel fpath <<< "$entry"
        fpath="${fpath/#\~/$HOME}"
        mkdir -p "$fpath"
        if has_folder "$fid"; then
            echo "==> Folder '$fid' already exists on introducer"
        else
            echo "==> Adding folder on introducer: $flabel ($fpath)"
            syncthing cli config folders add --id "$fid" --label "$flabel" --path "$fpath"
        fi
    done
fi

# --- Client setup ---
if [ "$LOCAL_ID" != "$INTRODUCER_ID" ]; then
    # 1. Add introducer device locally (with introducer + auto-accept-folders flags)
    if has_device "$INTRODUCER_ID"; then
        echo "==> Introducer already added, updating"
        set_device_addresses "$INTRODUCER_ID" \
            "tcp://$INTRODUCER_TS_IP:22000" "quic://$INTRODUCER_TS_IP:22000"
        syncthing cli config devices "$INTRODUCER_ID" introducer set true
        syncthing cli config devices "$INTRODUCER_ID" auto-accept-folders set true
    else
        echo "==> Adding introducer: $INTRODUCER_NAME"
        syncthing cli config devices add \
            --device-id "$INTRODUCER_ID" \
            --name "$INTRODUCER_NAME" \
            --addresses "tcp://$INTRODUCER_TS_IP:22000" \
            --addresses "quic://$INTRODUCER_TS_IP:22000" \
            --introducer \
            --auto-accept-folders
    fi

    # 2. Register self on introducer + share folders via SSH
    echo "==> Registering on introducer via SSH..."
    HOSTNAME=$(hostname | tr -cd 'a-zA-Z0-9._-')

    # Build folder share commands for the remote script
    FOLDER_CMDS=""
    for entry in "${SHARED_FOLDERS[@]}"; do
        IFS='|' read -r fid flabel fpath <<< "$entry"
        FOLDER_CMDS+="syncthing cli config folders '$fid' devices add --device-id '$LOCAL_ID' 2>/dev/null || true; "
    done

    ssh "$INTRODUCER_SSH" bash -s <<REMOTE
        set_device_addresses() {
            local dev_id="\$1"; shift
            local indices
            indices=\$(syncthing cli config devices "\$dev_id" addresses list 2>/dev/null)
            for i in \$(echo "\$indices" | sort -rn); do
                syncthing cli config devices "\$dev_id" addresses "\$i" delete
            done
            for addr in "\$@"; do
                syncthing cli config devices "\$dev_id" addresses add "\$addr"
            done
        }

        if syncthing cli config devices list | grep -qF '$LOCAL_ID'; then
            echo 'Device already known, updating address'
            set_device_addresses '$LOCAL_ID' 'tcp://$TS_IP:22000' 'quic://$TS_IP:22000'
        else
            syncthing cli config devices add \\
                --device-id '$LOCAL_ID' \\
                --name '$HOSTNAME' \\
                --addresses 'tcp://$TS_IP:22000' \\
                --addresses 'quic://$TS_IP:22000' \\
                --auto-accept-folders
            echo 'Device registered on introducer'
        fi

        # Share all folders with this client on the introducer
        $FOLDER_CMDS
        echo 'Folder sharing configured on introducer'
REMOTE

    # 3. Add shared folders locally
    for entry in "${SHARED_FOLDERS[@]}"; do
        IFS='|' read -r fid flabel fpath <<< "$entry"
        fpath="${fpath/#\~/$HOME}"
        mkdir -p "$fpath"
        if has_folder "$fid"; then
            echo "==> Folder '$fid' already exists"
        else
            echo "==> Adding folder: $flabel ($fpath)"
            syncthing cli config folders add --id "$fid" --label "$flabel" --path "$fpath"
        fi
        # Ensure introducer is in the folder's device list
        syncthing cli config folders "$fid" devices add \
            --device-id "$INTRODUCER_ID" 2>/dev/null || true
    done
    # Introducer will propagate other peers automatically via introducer mechanism
fi

# --- .stignore ---
COPILOT_STIGNORE="$HOME/.copilot/.stignore"
COPILOT_STIGNORE_SHARED="$HOME/.copilot/.stignore-shared"

if [ ! -f "$COPILOT_STIGNORE_SHARED" ]; then
    cat > "$COPILOT_STIGNORE_SHARED" << 'IGN'
// Syncthing selective sync for ~/.copilot
/pkg
/logs
.stfolder
*.tmp
*.lock
*.db-journal
*.db-wal
*.db-shm
IGN
    echo "==> Created $COPILOT_STIGNORE_SHARED"
fi

if [ ! -f "$COPILOT_STIGNORE" ]; then
    echo '#include .stignore-shared' > "$COPILOT_STIGNORE"
    echo "==> Created $COPILOT_STIGNORE"
fi

echo ""
echo "==> Done! ($LOCAL_ID)"
if [ "$LOCAL_ID" = "$INTRODUCER_ID" ]; then
    echo "    Introducer ready. New clients will be auto-discovered."
else
    echo "    Registered with introducer. Other peers will be introduced automatically."
fi
